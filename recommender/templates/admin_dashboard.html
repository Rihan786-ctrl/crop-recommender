{% extends "base.html" %}
{% load static %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<h3 class="text-center mb-3"><i class="fa-solid fa-gauge"></i> Dashboard</h3>

<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="card shadow-sm border-0">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted m-2">Users</div>
                    <div class="h3 m-1">{{ total_users }}</div>
                </div>
                <i class="fa-solid fa-users fa-2xl text-success"></i>
            </div>
        </div>
    </div>
   
    <div class="col-md-6">
        <div class="card shadow-sm border-0">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-muted m-2">Predictions</div>
                    <div class="h3 m-1">{{ total_predictions }}</div>
                </div>
                <i class="fa-solid fa-seedling fa-2xl text-success"></i>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-6">
        <div class="card shadow-sm border-0">
            <div class="card-body" style="height: 350px;">
                <h5 class="mb-3"><i class="fa-solid fa-chart-column"></i> Top Crops</h5>
                <canvas id="cropBar"></canvas>
            </div>
        </div>
    </div>
   
    <div class="col-md-6">
        <div class="card shadow-sm border-0">
            <div class="card-body" style="height: 350px;">
                <h5 class="mb-3"><i class="fa-solid fa-chart-line"></i> Predictions (7 days)</h5>
                <canvas id="dailyLine"></canvas>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.1/dist/chart.umd.min.js"></script>
<script>
const cropLabels = {{ crop_labels_json|safe }};
const cropCounts = {{ crop_counts_json|safe }};
const dayLabels = {{ day_labels_json|safe }};
const dayCounts = {{ day_counts_json|safe }};

function makeOrReplaceChart(canvasID, config) {
    const existing = Chart.getChart(canvasID);
    if (existing) {
        existing.destroy();
    }
    const canvas = document.getElementById(canvasID);
    if (!canvas) {
        console.error("Canvas with ID " + canvasID + " not found.");
        return null;
    }
    return new Chart(canvas, config);
}

// Crop Bar Chart
makeOrReplaceChart('cropBar', {
    type: 'bar',
    data: {
        labels: cropLabels,
        datasets: [{
            label: 'Number of Predictions',
            data: cropCounts,
            backgroundColor: 'rgba(75, 192, 75, 0.6)',
            borderColor: 'rgba(75, 192, 75, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: { beginAtZero: true }
        }
    }
});

// Daily Line Chart
makeOrReplaceChart('dailyLine', {
    type: 'line',
    data: {
        labels: dayLabels,
        datasets: [{
            label: 'Predictions',
            data: dayCounts,
            borderColor: 'rgba(54, 162, 235, 1)',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: { beginAtZero: true }
        }
    }
});
</script>

{% endblock %}